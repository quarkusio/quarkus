# Docker image
# Build a Docker image to deploy, run, or push to a container registry.
# Add steps that use Docker Compose, tag images, push to a registry, run an image, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
  batch: true
  branches:
    include:
      - master

pr:
  branches:
    include:
      - master
  paths:
    exclude:
      - docs/src/main/asciidoc/*
      - docs/src/main/asciidoc/images/*
      - README.md
      - CONTRIBUTING.md
      - LICENSE.txt
      - dco.txt

variables:
  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository/
  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'
  QUARKUS_LOCAL_REPO: $(MAVEN_CACHE_FOLDER)

stages:
  #This stage uses the azure caching feature to reduce the downloads that are performed from central, which greatly speeds up CI
  #This is it's own stage to prevent Quarkus artifacts produced by the build from being cached
  - stage: cache_maven_repo_stage
    displayName: 'Maven Cache'
    jobs:
      - job: Cache_Maven_Repo
        displayName: 'Deploy'
        timeoutInMinutes: 30
        pool:
          vmImage: 'Ubuntu 16.04'

        variables:
          imageName: 'quarkus:$(build.buildId)'

        steps:

          - task: CacheBeta@0
            inputs:
              key: maven | bom/runtime/pom.xml   #if we attempt to use all poms then when they get copied to target everything breaks. This should be good enough, it does not need to be perfect
              path: $(MAVEN_CACHE_FOLDER)
              securityNamespace: cache
            displayName: Cache Maven local repo

          - task: Maven@3
            displayName: 'Maven Build'
            inputs:
              goals: 'package'
              mavenOptions: $(MAVEN_OPTS)
              options: '-B --settings azure-mvn-settings.xml -DskipTests=true -Dno-format'

          - publish: $(MAVEN_CACHE_FOLDER)
            artifact: MavenRepo

  #This stage builds the Quarkus artifacts needed for native image testing
  #but also tests JDK8 linux. While it would be more parallel to have a separate JDK8 test run,
  #and build this run with tests skipped, this means that if there is a problem with the JVM run
  #we do not waste time on native runs, and also uses less agent time overall
  - stage: build_artifact_for_native_stage
    displayName: 'Build for Native'
    dependsOn: cache_maven_repo_stage
    jobs:
      - job: Build_JDK8_Linux
        displayName: 'Build JDK8 Linux'
        timeoutInMinutes: 60
        pool:
          vmImage: 'Ubuntu 16.04'

        variables:
          imageName: 'quarkus:$(build.buildId)'

        steps:
          - template: ci-templates/jvm-build-steps.yaml

          - publish: $(MAVEN_CACHE_FOLDER)
            artifact: BuiltMavenRepo

  - stage: run_jvm_tests_stage
    displayName: 'Run JVM Tests'
    dependsOn: cache_maven_repo_stage
    jobs:
      - job: Windows_Build
        displayName: 'Windows JVM Build'
        timeoutInMinutes: 60
        pool:
          vmImage: 'vs2017-win2016'
        variables:
          imageName: 'quarkus-windows:$(build.buildId)'
          MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository
          MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: MavenRepo
              path: $(MAVEN_CACHE_FOLDER)

          - task: Maven@3
            displayName: 'Maven Build'
            inputs:
              goals: 'install'
              mavenOptions: $(MAVEN_OPTS)
              options: '-B --settings azure-mvn-settings.xml -Dno-native -Dno-format'

      - job: Build_JDK11_Linux
        timeoutInMinutes: 60
        displayName: 'Linux JDK11 Build'
        pool:
          vmImage: 'Ubuntu 16.04'
        variables:
          imageName: 'quarkus-jdk11:$(build.buildId)'
        steps:
          - template: ci-templates/jvm-build-steps.yaml

      - job: Run_TCKs
        timeoutInMinutes: 45
        pool:
          vmImage: 'Ubuntu 16.04'
        variables:
          imageName: 'quarkus:$(build.buildId)'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: MavenRepo
              path: $(MAVEN_CACHE_FOLDER)
          - task: Maven@3
            displayName: 'Maven Install'
            inputs:
              goals: 'install'
              mavenOptions: $(MAVEN_OPTS)
              options: '-B --settings azure-mvn-settings.xml -Dno-native -Dno-format -DskipTests -Dtcks'
          - task: Maven@3
            displayName: 'Maven Verify'
            inputs:
              goals: 'verify'
              mavenOptions: $(MAVEN_OPTS)
              mavenPomFile: 'tcks/pom.xml'


  - stage: run_native_tests_stage
    displayName: 'Native Tests'
    dependsOn: build_artifact_for_native_stage
    jobs:
      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: amazon-dynamodb
          name: amazon_dynamodb
          dynamodb: true

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: amazon-lambda
          name: amazon_lambda

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: artemis-core
          name: artemis_core

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: artemis-jms
          name: artemis_jms

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: elytron-security-oauth2
          name: elytron_security_oauth2

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: elytron-security
          name: elytron_security

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: flyway
          name: flyway

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: hibernate-orm-panache
          name: hibernate_orm_panache

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: hibernate-search-elasticsearch
          name: hibernate_search_elasticsearch

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: hibernate-validator
          name: hibernate_validator

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: infinispan-cache-jpa
          name: infinispan_cache_jpa

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: infinispan-client
          name: infinispan_client

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: jgit
          name: jgit

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: jpa-h2
          name: jpa_h2

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: jpa-mariadb
          name: jpa_mariadb

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: jpa-mssql
          name: jpa_mssql

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: jpa-postgresql
          name: jpa_postgresql
          postgres: true

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: jpa
          name: jpa

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: kafka
          name: kafka

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: keycloak
          name: keycloak

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: kogito
          name: kogito

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: kubernetes-client
          name: kubernetes_client

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: main
          name: main
          postgres: true

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: mongodb-client
          name: mongodb_client

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: neo4j
          name: neo4j

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: reactive-pg-client
          name: reactive_pg_client
          postgres: true

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: resteasy-jackson
          name: resteasy_jackson

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: spring-di
          name: spring_di

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: spring-web
          name: spring_web

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: test-extension
          name: test_extension

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: tika
          name: tika

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: vertx
          name: vertx

      - template: ci-templates/native-build-steps.yaml
        parameters:
          module: virtual-http
          name: virtual_http